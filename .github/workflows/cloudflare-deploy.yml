# GitHub Actions workflow for deploying to Cloudflare Workers
# Secrets must be configured in GitHub repository settings:
# - CLOUDFLARE_API_TOKEN: Cloudflare API token with Workers edit permission
# - CLOUDFLARE_ACCOUNT_ID: Cloudflare Account ID
# - SUPABASE_URL: Supabase project URL
# - SUPABASE_ANON_KEY: Supabase anonymous key
# - SUPABASE_SERVICE_ROLE_KEY: (optional) Supabase service role key

name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
    paths:
      - 'api/**'
      - '.github/workflows/cloudflare-deploy.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy API to Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'api/package-lock.json'

      - name: Install dependencies
        run: |
          cd api
          npm ci

      - name: Type check
        run: |
          cd api
          npx tsc --noEmit

      - name: Create wrangler.toml from environment variables
        run: |
          cd api
          cat > wrangler.toml << EOF
          name = "famouspeople-api"
          main = "src/worker.ts"
          compatibility_date = "2024-01-01"
          compatibility_flags = ["nodejs_compat"]
          account_id = "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"

          [build]
          command = ""

          [[rules]]
          type = "ESModule"
          globs = ["**/*.ts", "**/*.tsx"]

          [env.production]
          name = "famouspeople-api"
          EOF

      - name: Deploy to Cloudflare Workers
        run: |
          cd api
          npx wrangler deploy \
            --config wrangler.toml \
            --var SUPABASE_URL:${{ secrets.SUPABASE_URL }} \
            --var SUPABASE_ANON_KEY:${{ secrets.SUPABASE_ANON_KEY }} \
            --var SUPABASE_SERVICE_ROLE_KEY:${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} \
            --var SUPABASE_JWT_SECRET:${{ secrets.SUPABASE_JWT_SECRET }} \
            --var DATABASE_URL:${{ secrets.DATABASE_URL }} \
            --var DATABASE_SCHEMA:${{ secrets.DATABASE_SCHEMA }} \
            --var ALLOWED_ORIGINS:${{ secrets.ALLOWED_ORIGINS }} \
            --var LOG_LEVEL:${{ secrets.LOG_LEVEL }} \
            --var SITE_URL:${{ secrets.SITE_URL }} \
            --var UPSTASH_REDIS_URL:${{ secrets.UPSTASH_REDIS_URL }} \
            --var UPSTASH_REDIS_TOKEN:${{ secrets.UPSTASH_REDIS_TOKEN }} \
            --var OPENAI_API_KEY:${{ secrets.OPENAI_API_KEY }} \
            --var OPENAI_EMBEDDING_MODEL:${{ secrets.OPENAI_EMBEDDING_MODEL }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment summary
        run: |
          echo "### Deployment completed :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Worker URL:** https://famouspeople-api.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
